@using MESWebDev.Common
@using MESWebDev.Models.IQC.VM
@using MESWebDev.Models.PE
@using MESWebDev.Models.ProdPlan
@using MESWebDev.Services
@using System.Data
@using System.Globalization
@inject ITranslationService TranslationService
@model DataTable

@{
    var languageCode = Context.Session.GetString("LanguageCode") ?? "vi";
    ViewData["Title"] = TranslationService.GetTranslation("MenuManagement", languageCode);
    Layout = "~/Views/Shared/_AdminLayout.cshtml";  

}
@section ContentHeader {
    @await Html.PartialAsync("_Breadcrumb", ViewBag.Breadcrumbs as List<MESWebDev.DTO.BreadcrumbItemDto>)
}
@try
{

    <div class="app-content">
        <div class="container-fluid">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <div class="float-start d-flex justify-content-center align-items-center">
                                <h3 class="card-title fw-bold fs-5">
                                    <i class="bi bi-exclamation-square text-warning"></i>
                                    Production Error List
                                </h3>
    
                            </div>
                            <div class="float-end d-flex justify-content-center align-items-center">
                                <a class="btn btn-warning btn-sm search-icon btn-search mx-3">
                                    <i class="bi bi-search" style="cursor: pointer;"></i>
                                    Search
                                </a>
                                <a id="DownloadData" class="btn btn-secondary btn-sm me-2">
                                    <i class="bi bi-download"></i>
                                    Download
                                </a>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="ResultArea">
                                @if (Model == null || Model.Rows.Count == 0)
                                {
                                    <h5 class="m-3">Click to <a class="btn btn-warning btn-sm btn-search">Search</a> button to show data.</h5>
                                }
                                else
                                {
                                    <partial name="ErrorList/_Result" model="@Model" />
                                }
                            </div>                            
                            
                        </div>
                    </div>
                </div>
            </div>
            <Partial name="ErrorList/__Search" />
            <Partial name="_LoadingPartial" />
        </div>
    </div>

}
catch(Exception ex)
{
    string t = ex.Message;
}

@section Scripts {
    <link href="~/css/pecss.css" rel="stylesheet" />
    <script src="~/js/loadingpage.js?@DateTime.Now.Ticks"></script>
    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/jquery-validation/dist/jquery.validate.min.js"></script>
    <script src="~/lib/jquery-validation-unobtrusive/jquery.validate.unobtrusive.min.js"></script>
    <script>
        $(document).ready(function () {
            $('.btn-search').click(function () {
                $('#searchModal').modal('show');
            });
        });

        $(document).ajaxStart(function () {
           // alert('I Love you')
            $("#loading").show();
        }).ajaxStop(function () {
            $("#loading").hide();
        });
        $(window).on('load', function () {
            $('#loading').hide();
        });

        $(document).on('click', '#btnSearch', function () {
            Search();
        });

        function Search() {
            var url = '@Url.Action("SearchErrorList", "UVAssyProduction")';
            var lotNo = $('#ip_lotNo').val();
            var processName = $('#ip_processName').val();
            $.ajax({
                type: "Post",
                url: url,
                data: {lotNo: lotNo, processName: processName},
                success: function (response) {
                    $('#searchModal').modal('hide');
                    $('#ResultArea').html(response);
                },
                error: function (xhr, status, error) {
                    alert("An error occurred while processing your request: " + error);
                }
            });
        }


        $('#DownloadData').on('click', function () {
            const headers = [];
            $('table thead tr:first th .header-text').each(function () {
                //alert($(this).text().trim());
                headers.push($(this).text().trim());
            });

            const rows = [];
            $('table tbody tr:visible').each(function () {
                const rowData = [];
                $(this).find('td.body-text').each(function () {
                    rowData.push($(this).text().trim());
                });
                rows.push(rowData);
            });

            const payload = { headers: headers, rows: rows };

            $.ajax({
                url: '/UVAssyProduction/ExportToExcel',
                type: 'POST',
                data: JSON.stringify(payload),
                contentType: 'application/json',
                xhrFields: { responseType: 'blob' }, // important to download file'
                success: function (data) {
                const blob = new Blob([data], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                //a.download = "FilteredData.xlsx";

                const now = new Date();
                const pad = (n) => n.toString().padStart(2, '0');
                const fileName = `ProdErrorList_${now.getFullYear()}${pad(now.getMonth() + 1)}${pad(now.getDate())}${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}.xlsx`;

                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                a.remove();
            }
            });
        });
    </script>
    
}