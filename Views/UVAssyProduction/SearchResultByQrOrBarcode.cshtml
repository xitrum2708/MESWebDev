@using MESWebDev.Services
@using System.Data
@model System.Data.DataTable
@inject ITranslationService T

@{
    var languageCode = Context.Session.GetString("LanguageCode") ?? "vi";
    ViewData["Title"] = T.GetTranslation("Search product by qrcode or barcode", languageCode);
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}
@section ContentHeader {
    @await Html.PartialAsync("_Breadcrumb", ViewBag.Breadcrumbs as List<MESWebDev.DTO.BreadcrumbItemDto>)
}
@{
    // Chỉ các cột bạn muốn hiển thị
    var cols = new[]
    {
        "LotNo","Line","QRCode","CategoryName",
        "ProcessID","ProcessName","CreatedBy",
        "CreatedDate","Barcode","Unitcode","Status","Timestamp"
    };

    // Helper an toàn + format ngày tại View
    Func<DataRow, string, string> Get = (r, c) =>
        (Model.Columns.Contains(c) && r[c] != DBNull.Value) ? Convert.ToString(r[c]) : "";

    Func<DataRow, string, string> GetDate = (r, c) =>
    {
        if (!Model.Columns.Contains(c) || r[c] == DBNull.Value) return "";
        if (r[c] is DateTime d1) return d1.ToString("yyyy/MM/dd HH:mm:ss");
        if (DateTime.TryParse(Convert.ToString(r[c]), out var d2)) return d2.ToString("yyyy/MM/dd HH:mm:ss");
        return ""; // ví dụ Timestamp là rowversion (binary) thì để trống/đổi cách hiển thị tùy bạn
    };
}
<style>
/* thêm vào site.css hoặc <style> ở view */
    #tbl thead th {
        position: sticky;
        top: 0;
        background: #fff; /* giữ nền trắng khi cuộn */
        z-index: 2;
}
</style>

<div class="app-content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">               
                <div class="card-body">                   
                    <form asp-action="SearchResultByQrOrBarcode" method="get" class="mb-3">
                        <div class="d-flex flex-wrap align-items-end">
                            @Html.AntiForgeryToken()
                            <!-- SearchTerm -->
                            <div class="form-group mx-2 py-1" style="min-width: 220px;">
                                <label>@T.GetTranslation("SearchTerm", languageCode):</label>
                                <input type="text" name="key" 
                                       placeholder="@T.GetTranslation("QR / Barcode / Unitcode",languageCode)"
                                       value="@(ViewBag.Key ?? "")"
                                       class="form-control form-control-sm" />
                            </div>
                            <!-- LotNo -->
                            <div class="form-group mx-2 py-1" style="min-width: 180px;">
                                <label>LotNo:</label>
                                <input type="text" name="lotno"
                                       placeholder="VD6796..."
                                       value="@(ViewBag.LotNo ?? "")"
                                       class="form-control form-control-sm" />
                            </div>
                            <!-- CategoryName (LIKE) -->
                            <div class="form-group mx-2 py-1" style="min-width: 200px;">
                                <label>Category Name:</label>
                                <input type="text" name="categoryName"
                                       placeholder="FCT SCL..."
                                       value="@(ViewBag.CategoryName ?? "")"
                                       class="form-control form-control-sm" />
                            </div>
                            <!-- Filter Button -->
                            <div class="form-group mx-2 py-1">
                                <button type="submit" class="btn btn-primary">@T.GetTranslation("Filter", languageCode)</button>
                            </div>  
                            <div class="form-group mx-2 py-1">
                                <button type="button" class="btn btn-success ms-2" id="btnExport">Download Excel</button>
                            </div>
                        </div>
                    </form>
                   
                    <div style="max-height:auto; overflow-y:auto;">
                        <table class="table table-sm table-striped table-bordered" id="tbl">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th style="width:42px"></th>
                                    <th class="text-center">Result</th>   <!-- ✅ thêm cột tiêu đề mới -->
                                    @foreach (var c in cols)
                                    {
                                        <th>@c</th>
                                    }
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (DataRow r in Model.Rows)
                                {
                                    // Lấy giá trị an toàn
                                    var proc = Get(r, "ProcessID");
                                    var qr = Get(r, "QRCode");
                                    var bc = Get(r, "Barcode");
                                    var hasQR = Model.Columns.Contains("HasAttachByQR") && Get(r, "HasAttachByQR") == "1";
                                    var hasBC = Model.Columns.Contains("HasAttachByBC") && Get(r, "HasAttachByBC") == "1";
                                    var show = hasQR || (!hasQR && hasBC); // ưu tiên QR, nếu không có thì dùng BC
                                    var hasNG = Model.Columns.Contains("HasNG") && Get(r, "HasNG") == "1";
                                    <tr data-proc="@proc"
                                        data-qr="@qr"
                                        data-bc="@bc"
                                        data-hasqr="@(hasQR ? "1" : "0")"
                                        data-hasbc="@(hasBC ? "1" : "0")">
                                        <td class="text-center">
                                            @if (show)
                                            {
                                                <button type="button" class="btn btn-outline-primary btn-sm btn-expand" title="Check attached file">+</button>
                                            }
                                            else
                                            {
                                                <span class="text-muted">—</span>
                                            }
                                        </td>
                                        <!-- Cột NG báo hiệu -->
                                        <td class="text-center">
                                                @if (hasNG)
                                                {
                                                <span class="badge bg-danger">NG</span>
                                                }
                                                else
                                                {
                                                <span class="badge bg-success">OK</span>
                                                }
                                        </td>
                                        @foreach (var c in cols)
                                        {
                                            if (c == "CreatedDate" || c == "Timestamp")
                                            {
                                                <td class="text-nowrap">@GetDate(r, c)</td>
                                            }
                                            else if (c == "QRCode" || c == "Barcode")
                                            {
                                                <td class="font-monospace">@Get(r, c)</td>
                                            }
                                            else
                                            {
                                                <td>@Get(r, c)</td>
                                            }
                                        }
                                    </tr>

                                    <tr class="child d-none">
                                        <td colspan="@(cols.Length + 1)"><div class="att-box">—</div></td>
                                    </tr>
                                }
                               </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.querySelectorAll(".btn-expand").forEach(btn=>{
          btn.addEventListener("click", async (e)=>{
            const tr   = e.target.closest("tr");
            const proc = (tr.dataset.proc || "").trim();
            const qr   = (tr.dataset.qr   || "").trim();
            const bc   = (tr.dataset.bc   || "").trim();
            const hasqr= tr.dataset.hasqr === "1";
            const hasbc= tr.dataset.hasbc === "1";

            const child = tr.nextElementSibling;
            const box   = child.querySelector(".att-box");

            // toggle đóng/mở
            if (!child.classList.contains("d-none")) { child.classList.add("d-none"); return; }

            // Ưu tiên QR, nếu không có thì BC
            let url = null;
            if (hasqr && qr) {
              url = '@Url.Action("Attachments", "UVAssyProduction")'
                  + `?processId=${encodeURIComponent(proc)}&qrcode=${encodeURIComponent(qr)}`;
            } else if (hasbc && bc) {
              url = '@Url.Action("Attachments", "UVAssyProduction")'
                  + `?processId=${encodeURIComponent(proc)}&qrcode=${encodeURIComponent(bc)}`;
            }

            if (!url) {
              box.textContent = "Không có file.";
              child.classList.remove("d-none");
              return;
            }

            box.textContent = "Đang tải...";
            const res  = await fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" }});
            const html = await res.text();
            box.innerHTML = html;
            child.classList.remove("d-none");
          });
        });

        document.getElementById("btnExport").addEventListener("click", function () {
            var table = document.getElementById("tbl");
            var html = table.outerHTML.replace(/ /g, '%20');

            // Tạo link download
            var a = document.createElement('a');
            a.href = 'data:application/vnd.ms-excel,' + html;
            a.download = 'UVASSY_Search_' + new Date().toISOString().slice(0,19).replace(/[:T]/g,'') + '.xls';
            a.click();
        });

    </script>
}
