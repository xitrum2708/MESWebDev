@using MESWebDev.Services
@using System.Data
@model System.Data.DataTable
@inject ITranslationService T

@{
    var languageCode = Context.Session.GetString("LanguageCode") ?? "vi";
    ViewData["Title"] = T.GetTranslation("Search product by qrcode or barcode", languageCode);
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}
@section ContentHeader {
    @await Html.PartialAsync("_Breadcrumb", ViewBag.Breadcrumbs as List<MESWebDev.DTO.BreadcrumbItemDto>)
}
@{
    // Chỉ các cột bạn muốn hiển thị
    var cols = new[]
    {
        "LotNo","Line","QRCode","CategoryName",
        "ProcessID","ProcessName","CreatedBy",
        "CreatedDate","Barcode","Unitcode","Status","Timestamp"
    };

    // Helper an toàn + format ngày tại View
    Func<DataRow, string, string> Get = (r, c) =>
        (Model.Columns.Contains(c) && r[c] != DBNull.Value) ? Convert.ToString(r[c]) : "";

    Func<DataRow, string, string> GetDate = (r, c) =>
    {
        if (!Model.Columns.Contains(c) || r[c] == DBNull.Value) return "";
        if (r[c] is DateTime d1) return d1.ToString("yyyy/MM/dd HH:mm:ss");
        if (DateTime.TryParse(Convert.ToString(r[c]), out var d2)) return d2.ToString("yyyy/MM/dd HH:mm:ss");
        return ""; // ví dụ Timestamp là rowversion (binary) thì để trống/đổi cách hiển thị tùy bạn
    };
}
<div class="app-content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">               
                <div class="card-body">                   
                    <form asp-action="SearchResultByQrOrBarcode" method="get" class="mb-3">
                        <div class="d-flex flex-wrap align-items-end">
                            @Html.AntiForgeryToken()
                            <!-- SearchTerm -->
                            <div class="form-group mx-2 py-1" style="min-width: 200px;">
                                <label>@T.GetTranslation("SearchTerm", languageCode):</label>
                                <input type="text" name="key" placeholder="@T.GetTranslation("Searchtext",languageCode)"
                                       value="@ViewBag.Key" class="form-control form-control-sm" />
                            </div>                           
                            <!-- Filter Button -->
                            <div class="form-group mx-2 py-1">
                                <button type="submit" class="btn btn-primary">@T.GetTranslation("Filter", languageCode)</button>
                            </div>                            
                        </div>
                    </form>
                   
                    <div style="max-height:auto; overflow-y:auto;">
                        <table class="table table-sm table-striped" id="tbl">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th style="width:42px"></th>
                                    @foreach (var c in cols)
                                    {
                                        <th>@c</th>
                                    }
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (DataRow r in Model.Rows)
                                {
                                    var has = Model.Columns.Contains("HasAttachment")
                                    && r["HasAttachment"] != DBNull.Value
                                    && Convert.ToInt32(r["HasAttachment"]) == 1;

                                    <tr data-proc="@Get(r, "ProcessID")" data-qr="@Get(r, "QRCode")">
                                        <td class="text-center">
                                            @if (has)
                                            {
                                                <button type="button" class="btn btn-outline-primary btn-sm btn-expand">+</button>
                                            }
                                            else
                                            {
                                                <span class="text-muted">—</span>
                                            }
                                        </td>

                                        @foreach (var c in cols)
                                        {
                                            if (c == "CreatedDate" || c == "Timestamp")
                                            {
                                                <td class="text-nowrap">@GetDate(r, c)</td>
                                            }
                                            else if (c == "QRCode" || c == "Barcode")
                                            {
                                                <td class="font-monospace">@Get(r, c)</td>
                                            }
                                           @*  else if (c == "ProcessID")
                                            {
                                                <td class="text-end">@Get(r, c)</td>
                                            } *@
                                            else
                                            {
                                                <td>@Get(r, c)</td>
                                            }
                                        }
                                    </tr>

                                    <tr class="child d-none">
                                        <td colspan="@(cols.Length + 1)"><div class="att-box">—</div></td>
                                    </tr>
                                }
                            </tbody>
                           @*  <tbody>
                                @foreach (System.Data.DataRow r in Model.Rows)
                                {
                                    var has = 0;
                                    if (Model.Columns.Contains("HasAttachment"))
                                        has = Convert.ToInt32(r["HasAttachment"]);

                                    <tr data-proc="@r["ProcessID"]" data-qr="@r["QRCode"]">
                                        <td>
                                            @if (has == 1)
                                            {
                                                <button type="button" class="btn btn-outline-primary btn-sm btn-expand">+</button>
                                            }
                                        </td>
                                        @foreach (System.Data.DataColumn c in Model.Columns)
                                        {
                                            <td>@r[c.ColumnName]</td>
                                        }
                                    </tr>
                                    <tr class="child d-none"><td colspan="@((Model.Columns.Count)+1)"><div class="att-box">—</div></td></tr>
                                }
                            </tbody> *@
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
@section Scripts {
    <script>
        document.querySelectorAll(".btn-expand").forEach(btn=>{
          btn.addEventListener("click", async (e)=>{
            const tr = e.target.closest("tr");
            const url = '@Url.Action("Attachments", "UVAssyProduction")'
              + `?processId=${tr.dataset.proc}&qrcode=${encodeURIComponent(tr.dataset.qr)}`;
            const child = tr.nextElementSibling, box = child.querySelector(".att-box");
            if (!child.classList.contains("d-none")) { child.classList.add("d-none"); return; }
            box.textContent = "Đang tải...";
            const html = await (await fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" }})).text();
            box.innerHTML = html;
            child.classList.remove("d-none");
          });
        });
    </script>
}