@using MESWebDev.Data
@using MESWebDev.Models.VM
@using System.Text.Json
@inject MESWebDev.Data.AppDbContext _context
@inject IHttpContextAccessor _httpContextAccessor
@{
    // Lấy UserId từ session
    var Username = Context.Session.GetString("Username");
    // Lấy ngôn ngữ
    var languageCode = Context.Session.GetString("LanguageCode") ?? "en";
    var languageId = _context.Master_Language
        .Where(l => l.Culture == languageCode)
        .Select(l => l.Id)
        .FirstOrDefault();

    var menuRow = _context.Auth_Master_User
        .Where(ur => ur.Username == Username)
        .Join(_context.Auth_Master_Role,
            ur => ur.RoleId,
            rp => rp.RoleId,
            (ur, rp) => rp)
        .Join(_context.Auth_Mapping_Role_Func_Pms,
            rp => rp.RoleId,
            p => p.RoleId,
            (rp, p) => p)
        .Where(p => p.IsActive)
        .Join(_context.Auth_Master_Function,
            p => p.FuncId,
            m => m.Id,
            (p, m) => m)
        .Where(m => m.IsActive)
        .OrderBy(m => m.Order)
        .Select(m => new FunctionModel
                {
                    Id = m.Id,
            //Url = m.Controller == null || m.Controller == "#"? "#" : Url.Action(m.Action, m.Controller),
                    Controller = m.Controller,
                    Action = m.Action,
                    Order = m.Order,
                    ParentId = m.ParentId,
                    IconString = m.IconString,
                    IsActive = m.IsActive,
                    EnName = _context.Master_Language_Dic
                                .Where(mt => mt.Key == m.Id.ToString() && mt.LangId == languageId)
                                .Select(mt => mt.Value)
                                .FirstOrDefault() ?? "No Translation"
                })
        .ToList();

    var menus = menuRow
        .GroupBy(m => m.Id)
        .Select(g => g.First())
        .ToList();

    List<FunctionModel> BuildMenuTree(List<FunctionModel> menus, int? parentId = null)
    {
        var rootMenus = menus
            .Where(m => m.ParentId == parentId)
            .OrderBy(m => m.Order)
            .Select(m => new FunctionModel
                    {
                        Id = m.Id,
                        Controller = m.Controller,
                        Action = m.Action,
                        Order = m.Order,
                        ParentId = m.ParentId,
                        IconString = m.IconString,
                        IsActive = m.IsActive,
                        EnName = m.EnName,
                        Children = BuildMenuTree(menus, m.Id) // Đệ quy
                    })
            .ToList();

        return rootMenus;
    }
    var menuTree = BuildMenuTree(menus);

    // Lấy URL hiện tại để đánh dấu menu active
    //var currentUrl = Context.Request.Path.ToString().ToLower();

    // var currentUrl = Context.Request.Path.Value.ToLower();
    // var currentMenu = _context.Auth_Master_Function
    // .AsEnumerable() // <— switch to client-side LINQ
    // .Where(m => string.IsNullOrEmpty(m.Action) && Url.Action(m.Action, m.Controller).ToString().ToLower().Contains(currentUrl) )
    // .FirstOrDefault();

    // var currentMenu = _context.Auth_Master_Function
    //     .Where(m => string.IsNullOrEmpty(m.Action) && Url.Action(m.Action,m.Controller) == currentUrl)
    //     .FirstOrDefault();


    var currentUrl = Context.Request.Path.Value.TrimEnd('/').ToLower();
    string[] controllers = new string[] { "/menu", "/user", "/translation", "/language", "/rolefuncpms", "/role" };
    foreach (var c in controllers)
    {
        if (currentUrl.StartsWith(c))
        {
            currentUrl = c;
            break;
        }
    }

    var menu = _context.Auth_Master_Function
        .Where(m => !string.IsNullOrEmpty(m.Controller) && !string.IsNullOrEmpty(m.Action) && m.IsActive)
        .AsEnumerable(); // Switch to client-side for Url.Action()

    var currentMenu = menu.FirstOrDefault(m =>
    {
        var menuUrl = Url.Action(m.Action, m.Controller)?.ToLower();
        return menuUrl == currentUrl; // or .StartsWith if you want partial match
    });

    var activeMenuId = currentMenu?.Id;     
}


<!DOCTYPE html>
<html lang="en">
<head>

    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="title" content="MES System | @ViewData["Title"]" />
    <meta name="author" content="ColorlibHQ" />
    <meta name="description" content="Uniden MES System" />
   
    <meta name="keywords" content="mes, mes system"/>
    
    <!-- Fonts -->
    <link rel="stylesheet" href="~/css/source-sans-3.css" />

    <!-- Third Party Plugins -->
    <link rel="stylesheet" href="~/css/overlayscrollbars.min.css" />
    <link rel="stylesheet" href="~/css/bootstrap-icons.min.css" />
    <link rel="stylesheet" href="~/css/apexcharts.css" />
    <link rel="stylesheet" href="~/css/jsvectormap.min.css" />
    <link rel="stylesheet" href="~/css/toastr.min.css" />
    <!-- AdminLTE -->
    <link rel="stylesheet" href="~/dist/css/adminlte.css" />

    <link rel="stylesheet" href="~/css/custom.css" />
    <link rel="stylesheet" href="~/css/site.css" />
    <link rel="stylesheet" href="~/css/Pagination.css" />


    <style>
        /* Giữ toast full-opacity */
        #toast-container > .toast {
            opacity: 1 !important;
        }

        /* Tùy chỉnh màu background và text cho loại “success” */
        .toast-success {
            background-color: #28a745 !important; /* hoặc mã màu bạn muốn */
            color: #fff !important;
        }

        /* Nếu muốn cho các loại khác cũng đậm hơn */
        .toast-error {
            background-color: #dc3545 !important;
            color: #fff !important;
        }

        .toast-info {
            background-color: #17a2b8 !important;
            color: #fff !important;
        }

        .toast-warning {
            background-color: #ffc107 !important;
            color: #000 !important;
        }
    </style>
    <title>@ViewData["Title"]</title>    
</head>

<body class="layout-fixed sidebar-expand-lg bg-body-tertiary">
    <div class="app-wrapper">   
        @* @Html.Partial("_LoadingOverlay") *@
        <!-- Header -->
        <nav class="app-header navbar navbar-expand bg-body">
            <div class="container-fluid">
                <ul class="navbar-nav d-flex justify-content-center align-items-center">
                    <li class="nav-item">
                        <a class="nav-link" data-lte-toggle="sidebar" href="#" role="button">
                            <i class="bi bi-list"></i>
                        </a>
                    </li>
                    @RenderSection("ContentHeader", required: false)
                </ul>
                <ul class="navbar-nav ms-auto">
                 
                    <li class="nav-item">
                        <a class="nav-link fullscreen" href="#" data-lte-toggle="fullscreen">
                            <i data-lte-icon="maximize" class="bi bi-arrows-fullscreen"></i>
                            <i data-lte-icon="minimize" class="bi bi-fullscreen-exit" style="display: none"></i>
                        </a>
                    </li>
                    <li class="nav-item dropdown user-menu">
                        <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown">
                            <img src="~/dist/assets/img/user2-160x160.jpg" class="user-image rounded-circle shadow" alt="User Image" />
                            <span class="d-none d-md-inline">@Context.Session.GetString("Username")</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-lg dropdown-menu-end">
                            <li class="user-header text-bg-primary">
                                <img src="~/dist/assets/img/user2-160x160.jpg" class="rounded-circle shadow" alt="User Image" />
                                <p>
                                    MES SYSTEM
                                    <small>@Context.Session.GetString("Username")</small>
                                </p>
                            </li>
                            <li class="user-footer">
                                @* <a href="#" class="btn btn-default btn-flat">Profile</a> *@
                                <a href="@Url.Action("Logout", "Account")" class="btn btn-default btn-flat float-end">Sign out</a>
                            </li>
                        </ul>
                    </li>
                </ul>
            </div>
        </nav>

        <!-- Sidebar -->
        <aside class="app-sidebar bg-body-secondary shadow" data-bs-theme="dark">
            <div class="sidebar-brand">
                <a href="@Url.Action("IQCDashboard", "Admin")" class="brand-link">
                    <img src="~/dist/assets/img/MesLogo2.png" alt="UV MES SYSTEM Logo" class="brand-image opacity-75 shadow" />
                    <span class="brand-text fw-light">UV MES SYSTEM</span>
                </a>
            </div>
            <div class="sidebar-wrapper">
                <nav class="mt-2">
                    <ul class="nav sidebar-menu flex-column" data-lte-toggle="treeview" role="menu" data-accordion="true">
                        @* @await Html.PartialAsync("_SidebarMenu", menuTree) *@
                        @await Html.PartialAsync("_SidebarMenu", menuTree, new ViewDataDictionary(ViewData) {
                        { "ActiveMenuId", activeMenuId }
                        })
                    </ul>
                </nav>
            </div>          
        </aside>
        
        <!-- Main Content -->
        <main class="app-main sidebar-collapsed">
            @RenderBody()
        </main>

        <!-- Footer -->
        <footer class="app-footer">
            <div class="float-end d-none d-sm-inline">Anything you want</div>
            <strong>
                Copyright © 2025 <a href="" class="text-decoration-none">Uniden MES System</a>.
            </strong>
            All rights reserved.
        </footer>
    </div>

    <!-- Scripts -->
    <script src="~/js/site-loading.js"></script>
    <script src="~/lib/jquery/jquery-3.6.0.min.js"></script>
    <script src="~/js/popper.min.js"></script>
    <script src="~/js/bootstrap.min.js"></script>
    <script src="~/js/overlayscrollbars.browser.es6.min.js"></script>
    <script src="~/dist/js/adminlte.js"></script>
    <script src="~/js/sortable.min.js"></script>
    <script src="~/js/apexcharts.min.js"></script>
    <script src="~/js/jsvectormap.min.js"></script>
    <script src="~/js/world.js"></script>
    <script src="~/js/toastr.min.js"></script>
    <script src="~/js/jquery.validate.min.js"></script>
    <script src="~/js/jquery.validate.unobtrusive.js"></script>

    <!-- OverlayScrollbars Configure -->
    <script>
        const SELECTOR_SIDEBAR_WRAPPER = '.sidebar-wrapper';
        const Default = {
            scrollbarTheme: 'os-theme-light',
            scrollbarAutoHide: 'leave',
            scrollbarClickScroll: true,
        };
        document.addEventListener('DOMContentLoaded', function () {
            const sidebarWrapper = document.querySelector(SELECTOR_SIDEBAR_WRAPPER);
            if (sidebarWrapper && typeof OverlayScrollbarsGlobal?.OverlayScrollbars !== 'undefined') {
                OverlayScrollbarsGlobal.OverlayScrollbars(sidebarWrapper, {
                    scrollbars: {
                        theme: Default.scrollbarTheme,
                        autoHide: Default.scrollbarAutoHide,
                        clickScroll: Default.scrollbarClickScroll,
                    },
                });
            }
        });
    </script>
    <script>
        document.querySelector('[data-lte-toggle="sidebar"]').addEventListener('click', function(e) {
            e.preventDefault();
            document.body.classList.toggle('sidebar-collapsed');
        });

        $(document).on('click', '.fullscreen', function () {
            // Delay 50ms để đợi UI cập nhật (icon swap)
            setTimeout(() => {
                    if ($('body').hasClass('sidebar-open')) {
                        console.log('Auto remove sidebar-collapsed in fullscreen');
                        $('body').removeClass('sidebar-collapsed');
                    }                
            }, 50);
        });

        // Cleanup class conflict
    </script>   

     <!-- Custom Script for Sidebar -->  
    @RenderSection("Scripts", required: false)    
    
</body>
</html>
