@using MESWebDev.Common
@using MESWebDev.Models.IQC.VM
@using MESWebDev.Models.SMT.VM
@using MESWebDev.Services
@using System.Data
@using System.Text.Json
@inject ITranslationService translate
@model SMT_ViewModel

@{
    var languageCode = Context.Session.GetString("LanguageCode") ?? "vi";
    ViewData["Title"] = translate.GetTranslation("MenuManagement", languageCode);
    Layout = "~/Views/Shared/_AdminLayout.cshtml";


    // Convert data to json here
    var lines = new List<string>();
    var ok_count = new List<int>();
    var ng_count = new List<int>();
    var ng_rate = new List<double>();

    string DatePeriod = $"Date period: {Model.StartDate?.ToString("yyyy/MM/dd")} ~ {Model.EndDate?.ToString("yyyy/MM/dd")}";
    
    if (Model.MachineSpectionData != null && Model.MachineSpectionData.Rows.Count > 0)
    {
        DataTable dt = Model.MachineSpectionData;
        foreach (DataRow row in dt.Rows)
        {
            lines.Add(row["Line"].ToString());
            ok_count.Add(Convert.ToInt32(row["OK_Count"]));
            ng_count.Add(Convert.ToInt32(row["NG_Count"]));
            ng_rate.Add(Convert.ToDouble(row["NG_Rate"]));
        }
    }
}
@section ContentHeader {
    @await Html.PartialAsync("_Breadcrumb", ViewBag.Breadcrumbs as List<MESWebDev.DTO.BreadcrumbItemDto>)
}
@try
{

    <div class="app-content">
        <div class="container-fluid">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <div class="float-start p-2 mt-1 bg-info text-dark mx-2 rounded-2">
                                <h3 class="card-title fw-bold fs-5 fw-bold">
                                    @DatePeriod
                                </h3>
                            </div>
                            <div class="float-end d-flex justify-content-center align-items-center">
                                <!-- StartDate -->
                                <div class="form-group mx-2 py-1" style="min-width: 180px;">
                                    @* <label>@translate.GetTranslation("StartDate", languageCode):</label> *@
                                    <input type="date" name="startDate" class="form-control"
                                           value="@(Model.StartDate.HasValue ? Model.StartDate.Value.ToString("yyyy-MM-dd") : "")" />
                                </div>
                                <div>
                                    <font class="fs-6 fw-bold"> ~ </font>
                                </div>
                                <!-- EndDate -->
                                <div class="form-group mx-2 py-1" style="min-width: 180px;">
                                    @* <label>@translate.GetTranslation("EndDate", languageCode):</label> *@
                                    <input type="date" name="endDate" class="form-control"
                                           value="@(Model.EndDate.HasValue ? Model.EndDate.Value.ToString("yyyy-MM-dd") : "")" />
                                </div>
                                <button class="btn btn-sm btn-info">
                                    <i class="bi bi-search"></i>
                                </button>
                                

                            </div>
                        </div>
                        <div class="card-body" >
                            @* <h2>Product Schedule (Resource Timeline View)</h2> *@
                            @* <div style="max-height: calc(100vh - 250px); overflow-y: auto; position:relative" id='calendar'></div> *@
                            <canvas id="chart_area" style="max-height: calc(100vh - 250px)"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <Partial name="_Upload" />
    <Partila name="_LoadingPartial" />
}
catch(Exception ex)
{
    string t = ex.Message;
}
@section Scripts {
    <script src="~/js/chart.js"></script>
    <script src="~/js/chartjs-plugin-datalabels.js"></script>
    <script>
        const labels = @Html.Raw(Json.Serialize(lines));
        const okData = @Html.Raw(Json.Serialize(ok_count));
        const ngData = @Html.Raw(Json.Serialize(ng_count));
        const ngRateData = @Html.Raw(Json.Serialize(ng_rate));
        const ctx = document.getElementById('chart_area').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'OK Count',
                        data: okData,
                        backgroundColor: 'green'
                    },
                    {
                        label: 'NG Count',
                        data: ngData,
                        backgroundColor: 'pink'
                    },
                    {
                        label: 'NG Rate',
                        type: 'line',
                        data: ngRateData,
                        backgroundColor: 'rgba(255, 206, 86, 0.5)',
                        borderColor: 'rgba(255, 206, 86, 1)',
                        fill: false,
                        yAxisID: 'y2'
                    }
                ]
            },
            options: {
                responsive: true,
                scales: {
                   y: {
                       beginAtZero: true,
                       position: 'left',
                       title:{
                           display: true,
                           text: 'Count'
                       },
                   },
                   y2:{
                          type: 'linear',
                          position: 'right',
                          beginAtZero: true,
                          title: {
                            display: true,
                            text: 'NG Rate'
                          },
                          grid: {
                            drawOnChartArea: false // only want the grid lines for one axis to show up
                          }
                     }
                   }
                }
            }
        });
    </script>
}